# ===========================
# Sectigo / InCommon Settings
# ===========================
# Enrollment REST API (OAuth, client-credentials)
export SECTIGO_AUTH_URL="${SECTIGO_AUTH_URL:-https://auth.sso.sectigo.com/auth/realms/apiclients/protocol/openid-connect/token}"

# >>> REQUIRED: Enrollment REST API OAuth client (created in SCM -> Enrollment REST API) <<<
export SECTIGO_ENROLL_CLIENT_ID=''
export SECTIGO_ENROLL_CLIENT_SECRET=''

# Base derived from v3/api-docs servers[].url template:
#   https://{customer}.enroll.{instance}.sectigo.com
export SECTIGO_CUSTOMER_SUBDOMAIN="${SECTIGO_CUSTOMER_SUBDOMAIN:-incommon}"
export SECTIGO_INSTANCE="${SECTIGO_INSTANCE:-enterprise}"
export SECTIGO_ENROLL_BASE="https://${SECTIGO_CUSTOMER_SUBDOMAIN}.enroll.${SECTIGO_INSTANCE}.sectigo.com"
export SECTIGO_POLL_MAX_WAIT="${SECTIGO_POLL_MAX_WAIT:-900}"   # seconds (15m)
export SECTIGO_POLL_BACKOFF_MIN="${SECTIGO_POLL_BACKOFF_MIN:-3}"
export SECTIGO_POLL_BACKOFF_MAX="${SECTIGO_POLL_BACKOFF_MAX:-30}"

# ===== curl defaults =====
export CURL_CONNECT_TIMEOUT="${CURL_CONNECT_TIMEOUT:-15}"
export CURL_MAX_TIME="${CURL_MAX_TIME:-90}"
export CURL_RETRY="${CURL_RETRY:-2}"
export CURL_RETRY_DELAY="${CURL_RETRY_DELAY:-2}"

# ===== Logging =====
export SECTIGO_LOG_DIR="${SECTIGO_LOG_DIR:-/fullPathTo/sectigo/logs}"
mkdir -p "$SECTIGO_LOG_DIR" 2>/dev/null || true
export SECTIGO_LOG_FILE="${SECTIGO_LOG_FILE:-$SECTIGO_LOG_DIR/sectigo.log}"

# ===== Lock file (optional) =====
export SECTIGO_LOCK_FILE="${SECTIGO_LOCK_FILE:-/fullPathTo/sectigo/sectigo.lock}"
mkdir -p "$(dirname "$SECTIGO_LOCK_FILE")" 2>/dev/null || true

# ===== Tooling guard =====
command -v curl >/dev/null 2>&1 || { echo "curl is required" >&2; exit 127; }
command -v jq   >/dev/null 2>&1 || { echo "jq is required"   >&2; exit 127; }
command -v openssl >/dev/null 2>&1 || { echo "openssl is required" >&2; exit 127; }

# ===========================
# CSR defaults (hard-coded)  #
# ===========================
# These values replace all interactive prompts from `openssl req`.
# You can override any of them at runtime with CLI flags if needed.
export CSR_COUNTRY=""                  # Country Name (C)
export CSR_STATE=""            # State or Province (ST)
export CSR_LOCALITY=""          # Locality / City (L)
export CSR_ORG=""                # Organization (O)
export CSR_OU=""                       # Organizational Unit (OU)
export CSR_EMAIL=""   # Email Address (optional; leave empty to omit)

# Common Name (CN) and SANs:
# - CN can be supplied at runtime; if omitted, we use CSR_CN_DEFAULT below.
# - SANs are optional. Comma-separated "DNS:host1,DNS:host2"
export CSR_CN_DEFAULT=""
export CSR_SANS_DEFAULT=""

# IMPORTANT:
# We do NOT set a "challenge password" or "optional company name".
# Those attributes are simply omitted in a non-interactive CSR.

# ===== Tenant binding note =====
# Your Enrollment client is bound to:
#   Profile: InCommon SSL Single Domain General Profile
#   Term   : 1 year
# Do NOT send profile/term in request payloads; server applies them automatically.

# ===== Renewal cron tunables (optional) =====
# Default days before expiry to trigger cron-renew
export SECTIGO_RENEW_DAYS=5
# Optional jitter (seconds) to avoid thundering herds in cron
export SECTIGO_CRON_JITTER_MAX=60
# Minimum hours between renewals of the same cert (throttle)
export SECTIGO_RENEW_MIN_INTERVAL_HOURS=24
# State directory for throttle stamps
export SECTIGO_STATE_DIR="$HERE/state"

# Optional notification hook; called as: $SECTIGO_NOTIFY_CMD <level> <message>
# e.g., log to syslog: export SECTIGO_NOTIFY_CMD="logger -t sectigo-renew"
# e.g., email wrapper: export SECTIGO_NOTIFY_CMD="/usr/local/bin/notify-sectigo"
# export SECTIGO_NOTIFY_CMD=""

# Default comment for SSL CSR submission
export SECTIGO_ORDER_COMMENT=""

# For Splunk Windows Forwarders - add Lets Encrpt root trust
# Lets Encrypt is current used for the Splunk indexer SSL

export LE_R3_URL="https://letsencrypt.org/certs/lets-encrypt-r3.pem"
export LE_ISRG_ROOT_URL="https://letsencrypt.org/certs/isrgrootx1.pem"
export SECTIGO_TRUST_OUT_DIR="$HERE/certs"
export SECTIGO_LE_BUNDLE_NAME="le-ca-bundle.pem"
export SECTIGO_COMPOSED_TRUST_NAME="sectigo_and_le_roots.pem"

